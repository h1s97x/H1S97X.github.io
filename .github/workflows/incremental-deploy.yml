name: Incremental Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]  # åªåœ¨ä¸»åˆ†æ”¯è§¦å‘
    paths:
      - 'source/**'  # åªç›‘å¬ source ç›®å½•ä¸‹çš„å˜åŒ–
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  incremental-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: Checkout gh-pages branch
      run: |
        git fetch origin gh-pages:gh-pages || echo "gh-pages branch not found, will create new one"
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Initialize theme submodules
      run: |
        git submodule update --init --recursive
        npm run themes:status
        
    - name: Detect changed files in source directory
      id: changes
      run: |
        echo "Detecting changes in source directory..."
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "Manual trigger - will do full build"
          echo "changed_files=all" >> $GITHUB_OUTPUT
        else
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^source/' || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes in source directory"
            echo "changed_files=none" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "changed_files=some" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Build static files (incremental)
      if: steps.changes.outputs.changed_files != 'none'
      run: |
        echo "ğŸ—ï¸ Building with Stellar theme (incremental mode)..."
        npm run build
        echo "ğŸ“Š Build statistics:"
        find public -name "*.html" | wc -l | xargs echo "Generated HTML files:"
        du -sh public | cut -f1 | xargs echo "Total size:"
        
    - name: Verify build output
      if: steps.changes.outputs.changed_files != 'none'
      run: |
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed: index.html not found"
          exit 1
        fi
        echo "âœ… Build verification passed"
        
    - name: Deploy to GitHub Pages (incremental)
      if: steps.changes.outputs.changed_files != 'none' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        force_orphan: false  # ä¿ç•™æäº¤å†å²ï¼Œå¢é‡æ›´æ–°
        keep_files: false  # ä¸ä¿ç•™æ—§æ–‡ä»¶ï¼Œä½†ä¿ç•™ git å†å²
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          deploy: incremental update from ${{ github.sha }}
          
          Source changes:
          ${{ github.event.head_commit.message }}
          
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ steps.changes.outputs.changed_files }}" == "none" ]; then
          echo "â„¹ï¸ No changes in source directory, skipping deployment"
        elif [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ å¢é‡éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒŸ ç½‘ç«™å·²æ›´æ–°åˆ° GitHub Pages"
          echo "ğŸ”— è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io"
          echo "ğŸ“ ä¿ç•™äº†å®Œæ•´çš„æäº¤å†å²"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
        fi
