function getRatingKey(t){return`rating-${t}`}function hasRated(t){return!!localStorage.getItem(getRatingKey(t))}function getRatedValue(t){return parseInt(localStorage.getItem(getRatingKey(t))||"0")}function storeRating(t,e){localStorage.setItem(getRatingKey(t),e)}function clearHover(t){t.querySelectorAll(".star").forEach(e=>e.classList.remove("hover"))}function updatePreview(t,e){const a=Math.floor(e);t.querySelectorAll(".star").forEach(o=>{const n=parseInt(o.dataset.value);o.classList.toggle("preview",n<=a)})}function setupHoverEffect(t){const e=t.querySelectorAll(".star");e.length&&e.forEach(a=>{const o=parseInt(a.dataset.value);a.addEventListener("mouseenter",()=>{e.forEach(n=>{n.classList.remove("preview");const r=parseInt(n.dataset.value);n.classList.toggle("hover",r<=o)})}),a.addEventListener("mouseleave",()=>{clearHover(t);const n=parseFloat(t.querySelector(".avg")?.textContent.replace(/[()]/g,"")||"0");updatePreview(t,n)})})}function calculateAverage(t={}){const e=Object.entries(t).filter(([n])=>!isNaN(Number(n))),a=e.reduce((n,[r,i])=>n+Number(r)*i,0),o=e.reduce((n,[,r])=>n+r,0);return o>0?(a/o).toFixed(1):"0.0"}async function loadRating(t){const e=t.dataset.id,a=t.dataset.api;if(!(!e||!a))try{const r=(await(await fetch(`${a}/info?id=${encodeURIComponent(e)}`)).json()).rating||{},i=calculateAverage(r),u=Object.entries(r).filter(([d])=>!isNaN(Number(d))).reduce((d,[,l])=>d+l,0);let c=t.querySelector(".avg");c||(c=document.createElement("span"),c.className="avg",t.appendChild(c)),c.textContent=`(${i})`;let s=t.querySelector(".count");s||(s=document.createElement("span"),s.className="count",t.appendChild(s)),s.textContent=`${u}`,updatePreview(t,i)}catch(o){console.warn(`[rating] \u52A0\u8F7D\u5931\u8D25: id=${e}`,o)}}async function submitRating(t,e){const a=t.dataset.id,o=t.dataset.api;if(!(!a||!o||hasRated(a))){storeRating(a,e),t.classList.add("rated");try{await fetch(`${o}/update?id=${encodeURIComponent(a)}&value=${e}`,{method:"POST"}),loadRating(t)}catch(n){console.warn(`[rating] \u63D0\u4EA4\u5931\u8D25: id=${a}`,n)}}}function initRatings(){document.querySelectorAll(".ds-rating").forEach(t=>{const{id:e,api:a}=t.dataset;!e||!a||(loadRating(t),setupHoverEffect(t),hasRated(e)&&t.classList.add("rated"),t.querySelectorAll(".star").forEach(o=>{const n=o.dataset.value;o.addEventListener("click",()=>{hasRated(e)||submitRating(t,n)})}))})}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",initRatings):initRatings();
