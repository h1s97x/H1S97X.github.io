name: Daily Repository Backup

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½ (UTCæ—¶é—´)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²
        submodules: recursive # åŒ…å«å­æ¨¡å—
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "Backup Bot"
        git config --global user.email "backup-bot@users.noreply.github.com"

    - name: Create backup bundle
      run: |
        # åˆ›å»ºåŒ…å«æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾çš„å¤‡ä»½åŒ…
        git bundle create backup-$(date +%Y%m%d).bundle --all
        
        # åˆ›å»ºå¤‡ä»½ä¿¡æ¯æ–‡ä»¶
        echo "# Repository Backup Information" > backup-info.md
        echo "- **Backup Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> backup-info.md
        echo "- **Source Repository**: ${{ github.repository }}" >> backup-info.md
        echo "- **Latest Commit**: $(git rev-parse HEAD)" >> backup-info.md
        echo "- **Total Commits**: $(git rev-list --all --count)" >> backup-info.md
        echo "- **Branches**: $(git branch -r | wc -l)" >> backup-info.md
        echo "- **Tags**: $(git tag | wc -l)" >> backup-info.md
        echo "" >> backup-info.md
        echo "## Recent Commits" >> backup-info.md
        git log --oneline -10 >> backup-info.md

    - name: Upload backup to backup repository
      env:
        BACKUP_TOKEN: ${{ secrets.BACKUP_REPO_TOKEN }}
        BACKUP_REPO: ${{ secrets.BACKUP_REPO_NAME }}
      run: |
        if [ -n "$BACKUP_TOKEN" ] && [ -n "$BACKUP_REPO" ]; then
          # å…‹éš†å¤‡ä»½ä»“åº“
          git clone https://${BACKUP_TOKEN}@github.com/${BACKUP_REPO}.git backup-repo
          cd backup-repo
          
          # åˆ›å»ºæ—¥æœŸç›®å½•
          BACKUP_DIR="backups/$(date +%Y)/$(date +%m)"
          mkdir -p "$BACKUP_DIR"
          
          # å¤åˆ¶å¤‡ä»½æ–‡ä»¶
          cp ../backup-*.bundle "$BACKUP_DIR/"
          cp ../backup-info.md "$BACKUP_DIR/backup-$(date +%Y%m%d)-info.md"
          
          # æ›´æ–°æœ€æ–°å¤‡ä»½é“¾æ¥
          ln -sf "$BACKUP_DIR/backup-$(date +%Y%m%d).bundle" "latest-backup.bundle"
          cp ../backup-info.md "latest-backup-info.md"
          
          # æäº¤å¤‡ä»½
          git add .
          git commit -m "Daily backup: $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push
          
          echo "âœ… Backup uploaded successfully to $BACKUP_REPO"
        else
          echo "âš ï¸ Backup repository not configured. Skipping upload."
        fi

    - name: Clean old backups (keep last 30 days)
      env:
        BACKUP_TOKEN: ${{ secrets.BACKUP_REPO_TOKEN }}
        BACKUP_REPO: ${{ secrets.BACKUP_REPO_NAME }}
      run: |
        if [ -n "$BACKUP_TOKEN" ] && [ -n "$BACKUP_REPO" ]; then
          cd backup-repo
          
          # åˆ é™¤30å¤©å‰çš„å¤‡ä»½æ–‡ä»¶
          find backups/ -name "*.bundle" -type f -mtime +30 -delete
          find backups/ -name "*-info.md" -type f -mtime +30 -delete
          
          # æ¸…ç†ç©ºç›®å½•
          find backups/ -type d -empty -delete
          
          # æäº¤æ¸…ç†ç»“æœ
          git add .
          git commit -m "Cleanup: Remove backups older than 30 days" || echo "No old backups to clean"
          git push
          
          echo "ğŸ§¹ Old backups cleaned up"
        fi

    - name: Create local backup archive
      run: |
        # åˆ›å»ºå®Œæ•´çš„é¡¹ç›®å‹ç¼©åŒ…
        tar -czf "hexo-blog-backup-$(date +%Y%m%d).tar.gz" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='public' \
          --exclude='.deploy_git' \
          .
        
        echo "ğŸ“¦ Local backup archive created: hexo-blog-backup-$(date +%Y%m%d).tar.gz"

    - name: Upload backup artifacts
      uses: actions/upload-artifact@v4
      with:
        name: daily-backup-${{ github.run_number }}
        path: |
          backup-*.bundle
          backup-info.md
          hexo-blog-backup-*.tar.gz
        retention-days: 30

    - name: Backup notification
      run: |
        echo "ğŸ‰ Daily backup completed successfully!"
        echo "ğŸ“Š Backup Statistics:"
        echo "   - Bundle size: $(du -h backup-*.bundle | cut -f1)"
        echo "   - Archive size: $(du -h hexo-blog-backup-*.tar.gz | cut -f1)"
        echo "   - Backup date: $(date)"