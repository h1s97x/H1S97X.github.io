function getVoteKey(t){return`vote-${t}`}function hasVoted(t){return!!localStorage.getItem(getVoteKey(t))}function getVotedValue(t){return localStorage.getItem(getVoteKey(t))}function storeVote(t,e){localStorage.setItem(getVoteKey(t),e)}function removeVote(t){localStorage.removeItem(getVoteKey(t))}function markVoted(t,e){t.classList.add("voted"),e==="up"?t.querySelector(".vote-up")?.classList.add("active"):e==="down"&&t.querySelector(".vote-down")?.classList.add("active")}function revertVote(t,e){const n=t.dataset.id;if(e==="up"){const o=t.querySelector(".up");o&&(o.textContent=Math.max(0,parseInt(o.textContent||"1")-1))}else if(e==="down"){const o=t.querySelector(".down");o&&(o.textContent=Math.max(0,parseInt(o.textContent||"1")-1))}t.classList.remove("voted","active"),t.querySelector(".vote-up")?.classList.remove("active"),t.querySelector(".vote-down")?.classList.remove("active"),removeVote(n)}async function loadVote(t){const e=t.dataset.id,n=t.dataset.api;if(!(!e||!n))try{const c=await(await fetch(`${n}/info?id=${encodeURIComponent(e)}`)).json();t.querySelector(".up").textContent=c.votes?.up??0,t.querySelector(".down").textContent=c.votes?.down??0}catch(o){console.warn(`[vote] \u52A0\u8F7D\u5931\u8D25: id=${e}`,o)}}function submitVote(t,e){const n=t.dataset.id,o=t.dataset.api;if(!n||!o||hasVoted(n))return;const c=t.querySelector(".up"),a=t.querySelector(".down");e==="up"&&c&&(c.textContent=parseInt(c.textContent||"0")+1),e==="down"&&a&&(a.textContent=parseInt(a.textContent||"0")+1),storeVote(n,e),markVoted(t,e),fetch(`${o}/update?id=${encodeURIComponent(n)}&value=${encodeURIComponent(e)}`,{method:"POST"}).catch(i=>{console.warn(`[vote] \u540E\u53F0\u540C\u6B65\u5931\u8D25\uFF0C\u64A4\u9500\u6295\u7968: id=${n}`,i),revertVote(t,e)})}function initVotes(){document.querySelectorAll(".ds-vote").forEach(t=>{const{id:e,api:n}=t.dataset;if(!e||!n)return;loadVote(t);const o=getVotedValue(e);o&&markVoted(t,o),t.querySelector(".vote-up")?.addEventListener("click",()=>{t.classList.contains("active")||submitVote(t,"up")}),t.querySelector(".vote-down")?.addEventListener("click",()=>{t.classList.contains("active")||submitVote(t,"down")})})}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",initVotes):initVotes();
