utils.jq(()=>{Array.from(document.getElementsByClassName("ds-memos")).forEach(l=>{const c=l.dataset.api;if(!c)return;const p=l.getAttribute("avatar")||def.avatar,m=l.getAttribute("limit"),o=c.match(/https:\/\/(.*?)\/(.*)/i)[1];utils.request(l,c,async s=>{const e=await s.json();let r=d.identify(e);if(r.version==="feature")return;const i=l.getAttribute("user")?.split(",")||[],t=l.getAttribute("hide")?.split(",")||[];await Promise.all(r.data.slice(0,m||r.data.length).map(u=>f(u,r,i,t,p,o).then(n=>$(l).append(n))))});async function f(s,e,r,i,t,u){const n=d[e.version]||d.feature;return`<div class="timenode">
                      <div class="header">${!r.length&&!i.includes("user")?await n.buildUser(s,e,t):""}
                      <span>${n.buildDate(s).toLocaleString()}</span></div>
                      <div class="body">${marked.parse(s.content||"")}
                      <p>${n.buildImages(s,u).join("")}</p>
                      </div></div>`}const d={"22-":{buildUser:async(s,e,r)=>`<div class="user-info">${r?`<img src="${r}">`:""}<span>${s.creatorName}</span></div>`,buildDate:s=>new Date(s.createdTs*1e3),buildImages:(s,e)=>(s.resourceList||[]).filter(r=>r.type?.includes("image/")).map(r=>`<p><img src="${r.externalLink||`https://${e}/o/r/${r.id}`}"></p>`)},"22+":{buildUser:async(s,e,r)=>{const i=s?.creator.split("/")[1];let t=e.users.find(a=>a.id===parseInt(i));t||(e.requests[i]||(e.requests[i]=fetch(`${e.site}/api/v1/users/${i}`).then(a=>a.json()).then(a=>{a.username?(t=a,e.users.push(a)):t=null}).finally(()=>delete e.requests[i])),await e.requests[i],t=e.users.find(a=>a.id===parseInt(i)));const u=t?t.nickname||t.username:"memos",n=t?.avatarUrl?`${e.site}${t.avatarUrl}`:r||"";return`<div class="user-info">${n?`<img src="${n}">`:""}<span>${u}</span></div>`},buildDate:s=>new Date(s.createTime),buildImages:s=>(s.resources||[]).filter(e=>e.type?.includes("image/")).map(e=>`<p><img src="${e.externalLink||`https://${o}/o/r/${e.id}`}"></p>`)},"25+":{buildUser:async(s,e,r)=>{const i=s?.creator.split("/")[1];let t=e.users.find(a=>a.name.split("/")[1]===i);t||(e.requests[i]||(e.requests[i]=fetch(`${e.site}/api/v1/users/${i}`).then(a=>a.json()).then(a=>{a.username?(t=a,e.users.push(a)):t=null}).finally(()=>delete e.requests[i])),await e.requests[i],t=e.users.find(a=>a.name.split("/")[1]===i)),console.log(JSON.stringify(t));const u=t?t.displayName||t.username:"memos",n=t?.avatarUrl?`${e.site}${t.avatarUrl}`:r||"";return`<div class="user-info">${n?`<img src="${n}">`:""}<span>${u}</span></div>`},buildDate:s=>new Date(s.createTime),buildImages:s=>(s.attachments||[]).filter(e=>e.type?.includes("image/")).map(e=>`<div class="image-bg"><img src="${e.externalLink||`https://${o}/file/${e.name}/${e.filename}`}"></div>`)},feature:{buildUser:async()=>"memos",buildDate:()=>new Date,buildImages:()=>[]},identify:s=>{let e={version:"feature",users:[],site:c.split("/api/v1")[0],requests:{},data:[]};return Array.isArray(s)?(e.version="22-",e.data=s,console.log("\u5F53\u524DMemos\u7248\u672C\u4E3A22-")):s.memos&&!s.memos[0].attachments?(e.version="22+",e.data=s.memos,console.log("\u5F53\u524DMemos\u7248\u672C\u4E3A22+")):s.memos&&s.memos[0].attachments?(e.version="25+",e.data=s.memos,console.log("\u5F53\u524DMemos\u7248\u672C\u4E3A25+")):(e.version="feature",console.log("\u5F53\u524DMemos\u7248\u672C\u8FC7\u9AD8\uFF0C\u8BF7\u5230Stellar\u793E\u533A\u53CD\u9988")),e}}})});
