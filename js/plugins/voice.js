function fillRoundRect(e,n,l,t,i,s,r){if(2*s>t||2*s>i)return!1;e.save(),e.translate(n,l),drawRoundRectPath(e,t,i,s),e.fillStyle=r||"#000",e.fill(),e.restore()}function strokeRoundRect(e,n,l,t,i,s,r,a){if(2*s>t||2*s>i)return!1;e.save(),e.translate(n,l),drawRoundRectPath(e,t,i,s),e.lineWidth=r||2,e.strokeStyle=a||"#000",e.stroke(),e.restore()}function drawRoundRectPath(e,n,l,t){e.beginPath(0),e.arc(n-t,l-t,t,0,Math.PI/2),e.lineTo(t,l),e.arc(t,l-t,t,Math.PI/2,Math.PI),e.lineTo(0,t),e.arc(t,t,t,Math.PI,Math.PI*3/2),e.lineTo(n-t,0),e.arc(n-t,t,t,Math.PI*3/2,Math.PI*2),e.lineTo(n,l-t),e.closePath()}function fillRoundRectPro(e,n,l,t,i,s,r,a,p,v){if(s+r>t||p+a>t||s+p>i||r+a>i)return!1;e.save(),e.translate(n,l),drawRoundRectPathPro(e,t,i,s,r,a,p),e.fillStyle=v||"#000",e.fill(),e.restore()}function drawRoundRectPathPro(e,n,l,t,i,s,r){e.beginPath(0),e.arc(n-s,l-s,s,0,Math.PI/2),e.lineTo(r,l),e.arc(r,l-r,r,Math.PI/2,Math.PI),e.lineTo(0,t),e.arc(t,t,t,Math.PI,Math.PI*3/2),e.lineTo(n-i,0),e.arc(n-i,i,i,Math.PI*3/2,Math.PI*2),e.lineTo(n,l-s),e.closePath()}function drawWave(e,n,l,t,i){for(let s=0;s<l.length;++s)fillRoundRect(e,4*s,(n-l[s])/2,2,l[s],t,i)}function drawWaveWhenPlaying(e,n,l,t,i,s,r){for(let a=0;a<t.length;++a)4*a+2<=l?fillRoundRect(e,4*a,(n-t[a])/2,2,t[a],i,s):4*a>=l?fillRoundRect(e,4*a,(n-t[a])/2,2,t[a],i,r):l-4*a>=1?(fillRoundRect(e,4*a,(n-t[a])/2,2,t[a],i,r),fillRoundRectPro(e,4*a,(n-t[a])/2,l-4*a,t[a],i,0,0,i,s)):(fillRoundRect(e,4*a,(n-t[a])/2,2,t[a],i,s),fillRoundRectPro(e,4*a,(n-t[a])/2,2-l+4*a,t[a],0,i,i,0,r))}function drawPlayLine(e,n,l,t){fillRoundRect(e,l,0,1,n,.1,t)}function createVoiceDom(e){for(let n=0;n<e.length;++n){let l=e[n];l.loop=!1;let t=l.currentTime;l.classList.contains("qq")?isNaN(l.duration)||l.duration===1/0?l.addEventListener("durationchange",()=>{createWaveDom(l)}):createWaveDom(l):l.classList.contains("wechat")&&(isNaN(l.duration)||l.duration===1/0?l.addEventListener("durationchange",()=>{createWechatVoiceDom(l)}):createWechatVoiceDom(l))}}function createWaveDom(e){let n=e.parentElement,l=n.querySelector("canvas");if(l.getContext("2d")){let i=e.duration,s=Math.floor(i),r=s+2>25?25:s+2,a=n.querySelector(".pause-btn"),p=n.querySelector(".play-btn"),v=n.querySelector(".voice-seconds");v.innerHTML=`${s>60?"..":s}"`;let y=window.devicePixelRatio;l.width=(r*2-1)*2*y,l.height=23*y,l.style.width=(r*2-1)*2+"px",l.style.height="23px";let o=[];for(let h=0;h<r;++h){let d=(Math.floor(Math.random()*51)+30)/100*l.height*.8;o.push(d)}var t=l.getContext("2d");t.scale(y,1);let c="#333",f="#999";l.classList.contains("right")&&(c="#ffffff",f="#1373b3"),utils.dark.mode==="dark"&&(c="#ccc",f="#707070",l.classList.contains("right")&&(c="#fff9",f="#6797b780"));let m=!1;drawWave(t,l.height,o,1,c),e.addEventListener("timeupdate",()=>{e.currentTime>0&&(utils.dark.mode==="dark"?(c="#ccc",f="#707070",l.classList.contains("right")&&(c="#fff9",f="#6797b780")):(c="#333",f="#999",l.classList.contains("right")&&(c="#ffffff",f="#1373b3")),utils.requestAnimationFrame(()=>{t.clearRect(0,0,l.width,l.height),drawWaveWhenPlaying(t,l.height,e.currentTime/e.duration*l.width/y,o,1,c,f),drawPlayLine(t,l.height,e.currentTime/e.duration/y*l.width,c)}))}),e.addEventListener("ended",()=>{e.pause(),a.style.display="none",p.style.display="flex",e.currentTime=0,utils.requestAnimationFrame(()=>{t.clearRect(0,0,l.width,l.height),drawWave(t,l.height,o,1,c)}),m=!1}),n.addEventListener("click",()=>{a.style.display==="flex"?(e.pause(),a.style.display="none",p.style.display="flex",m=!1):(e.play(),a.style.display="flex",p.style.display="none",m=!0)}),utils.dark.push(function(){m||(utils.dark.mode==="dark"?(c="#ccc",f="#707070",l.classList.contains("right")&&(c="#fff9",f="#6797b780")):(c="#333",f="#999",l.classList.contains("right")&&(c="#ffffff",f="#1373b3")),e.currentTime>0?utils.requestAnimationFrame(()=>{t.clearRect(0,0,l.width,l.height),drawWaveWhenPlaying(t,l.height,e.currentTime/e.duration*l.width/y,o,1,c,f),drawPlayLine(t,l.height,e.currentTime/e.duration/y*l.width,c)}):utils.requestAnimationFrame(()=>{t.clearRect(0,0,l.width,l.height),drawWave(t,l.height,o,1,c)}))})}else console.log("\u6D4F\u89C8\u5668\u4E0D\u652F\u6301canvas")}function createCssStyle(e,n){let l=e.duration,t=Math.floor(l),i=t+2>25?25:t+2,s=e.parentElement,r=s.querySelector(".pause-btn"),a=s.querySelector(".play-btn"),p=s.querySelector(".voice-seconds");p.innerHTML=`${t>60?"..":t}"`;let v=(2*i-1)*2;t+2>25&&(s.style.width="100%");let y=document.createElement("div"),o=document.createElement("div");o.className="play-line",y.append(o),y.className=`voice-wave voice-wave-${n+1}`;for(let m=0;m<i;m++){let h=document.createElement("span");h.className="voice-wave-item",y.append(h)}s.insertBefore(y,s.querySelector(".voice-metas")),e.addEventListener("ended",()=>{e.pause(),r.style.display="none",a.style.display="flex",e.currentTime=0,o.classList.remove("active"),o.classList.add("back")}),s.addEventListener("click",()=>{r.style.display==="flex"?(e.pause(),r.style.display="none",a.style.display="flex",e.currentTime=0,o.classList.remove("active"),o.classList.add("back")):(e.play(),r.style.display="flex",a.style.display="none",o.classList.add("active"),o.classList.remove("back"))});let c=`
    .voice-wave.voice-wave-${n+1}>.play-line {
        transition: transform ${l}s linear;
        -moz-transition: transform ${l}s linear;
        -webkit-transition: transform ${l}s linear;
        -o-transition: transform ${l}s linear;
    }
    .voice-wave.voice-wave-${n+1}>.play-line.active {
        transform: translateX(${v}px);
    }
    `;for(let m=0;m<i;++m)c+=`
        .voice-wave-${n+1} span.voice-wave-item:nth-child(${m+1}) {
            height: ${(Math.floor(Math.random()*8)+3)*10}%;
            margin-left: ${m==0?0:2}px;
        }
        `;let f=document.createElement("style");f.setAttribute("type","text/css"),f.innerHTML=c,document.getElementsByTagName("head").item(0).appendChild(f)}function createWechatVoiceDom(e){let n=e.parentElement,l=n.querySelector(".wechat-voice"),t=e.duration,i=Math.floor(t),s=n.querySelector(".voice-seconds");s.innerHTML=`${i>60?"..":i}"`;let r=n.querySelector(".voice-placeholder");r.style.width=i*2+"px";let a=!1;e.addEventListener("ended",()=>{e.pause(),l.classList.remove("play"),e.currentTime=0,a=!1}),n.addEventListener("click",()=>{a?(e.pause(),l.classList.remove("play"),a=!1):(e.play(),l.classList.add("play"),a=!0)})}
