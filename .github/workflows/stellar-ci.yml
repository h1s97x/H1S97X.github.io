name: Stellar Theme CI/CD

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  validate:
    name: Validate Stellar Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Initialize submodules
      run: |
        git submodule update --init --recursive
        echo "ğŸ“¦ Theme submodules status:"
        npm run themes:status
        
    - name: Validate Stellar theme configuration
      run: |
        echo "ğŸ” Running Stellar theme validation..."
        npm run stellar:validate
        
    - name: Lint code
      run: npm run lint
      
    - name: Run unit tests
      run: npm test || echo "âš ï¸ Some tests failed"

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Initialize submodules
      run: git submodule update --init --recursive
      
    - name: Run Stellar test build
      run: |
        echo "ğŸ§ª Running Stellar theme test build..."
        npm run stellar:test
        
    - name: Verify build artifacts
      run: |
        echo "ğŸ“Š Build verification:"
        if [ ! -d "public" ]; then
          echo "âŒ Public directory not found"
          exit 1
        fi
        
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Index.html not generated"
          exit 1
        fi
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        echo "âœ… Checking key files:"
        [ -f "public/css/main.css" ] && echo "  âœ“ CSS files generated"
        [ -f "public/js/main.js" ] && echo "  âœ“ JS files generated"
        [ -f "public/search.json" ] && echo "  âœ“ Search index generated"
        [ -f "public/sitemap.xml" ] && echo "  âœ“ Sitemap generated"
        [ -f "public/atom.xml" ] && echo "  âœ“ RSS feed generated"
        
        # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
        html_count=$(find public -name "*.html" | wc -l)
        echo "ğŸ“„ Generated $html_count HTML files"
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        total_size=$(du -sh public | cut -f1)
        echo "ğŸ“¦ Total build size: $total_size"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: stellar-build-${{ github.sha }}
        path: public/
        retention-days: 7

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: stellar-build-${{ github.sha }}
        path: public/
        
    - name: Deploy to preview environment
      run: |
        echo "ğŸš€ Would deploy to preview environment"
        echo "ğŸ“ Preview URL would be available for PR review"
        # è¿™é‡Œå¯ä»¥é›†æˆ Netlify, Vercel æˆ–å…¶ä»–é¢„è§ˆæœåŠ¡
        
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: stellar-build-${{ github.sha }}
        path: public/
        
    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
      
    - name: Run Lighthouse CI
      run: |
        echo "ğŸ” Running performance tests..."
        # å¯åŠ¨ç®€å•çš„HTTPæœåŠ¡å™¨
        npx http-server public -p 8080 &
        sleep 5
        
        # è¿è¡ŒLighthouseæµ‹è¯•
        lhci autorun --upload.target=temporary-public-storage --collect.url=http://localhost:8080 || echo "âš ï¸ Performance test completed with warnings"
        
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=moderate || echo "âš ï¸ Security audit completed with warnings"
        
    - name: Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        if find . -name "*.key" -o -name "*.pem" -o -name ".env" | grep -v node_modules | grep -q .; then
          echo "âŒ Sensitive files found!"
          exit 1
        else
          echo "âœ… No sensitive files detected"
        fi